---
title: "sustainability_group3 - Trees"
date: "2023-02-06"
author: "Fabian Lüthard, Elisabeth Freimann, Simon Kohler"
output:
  html_document:
    df_print: paged
    toc: yes
    theme: united
    number_sections: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# TREES  -  TREES  -  TREES

## Introduction




## Goal of the project:
Does the planting of trees and the development of areas of green spaces have a positive correlation with the development of air quality indicators in the city of Zurich?
More specific questions after exploratory analysis.



## Big Picture: Embedding in the Sustainable Development Goals (SDG)


## Data sources

### Tree cadastre

Format: csv
Number of rows: 36'239
Number of variables: 17 (most important: year of  planting, diameter of crown, 
district) 
Source: https://data.stadt-zuerich.ch/dataset/geo_baumkataster 


## Data preparation


## Importing all packages and libraries

The following libraries were used to analyse the data:

```{r lib, echo=FALSE, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(tseries)
library(astsa)
library(imputeTS)
library(forecast)
library(magrittr)
library(dplyr)
library(lubridate)
library(tidyr)  
library(ggplot2)
library(reshape2) 

```

## Loading the data

```{r trees, echo=TRUE}
d.trees <- read.csv('../datasets/gsz.baumkataster_baumstandorte.csv', encoding = "UTF-8")
names(d.trees)[1] <- "objid" 
#head(trees)
#str(trees)


#Wrangling and mutating tree data

# trees by year
tree_ts <- d.trees %>%
  dplyr::select(pflanzjahr) %>%
  filter(pflanzjahr > 1980) %>%
  group_by(pflanzjahr) %>%
  summarise(count = n())

# Trees by district
tree_quartier <- d.trees %>%
  dplyr::select(pflanzjahr, objid, quartier) %>%
  filter(pflanzjahr > 1980) %>%
  group_by(pflanzjahr, quartier) %>%
  summarise(count = n())


# sum of trees
tree_ts_sum <- tree_ts %>%
 mutate(sum_trees = cumsum(count))


# Trees by district, year
tree_quartier_year_full <- d.trees %>%
  dplyr::select(pflanzjahr, quartier, kronendurchmesser) %>%
  filter(pflanzjahr > 1980) %>%
  group_by(pflanzjahr, quartier) %>%
  summarise(count = n(), sum_crown = sum(kronendurchmesser))

# trees by year
tree_year <- d.trees %>%
  dplyr::select(pflanzjahr, kronendurchmesser) %>%
  filter(pflanzjahr > 1980) %>%
  group_by(pflanzjahr) %>%
  summarise(tree_count = n(), crown_sum = sum(kronendurchmesser))

tree_year_sum <- tree_year %>%
  mutate(cum_trees = cumsum(tree_count)) %>%
  mutate(cum_crown = cumsum(crown_sum))


```

```{r temp, echo=TRUE}
filenames.meteo <- list.files(path = "../datasets/meteo/", pattern = "*.csv", full.names = TRUE)
data_list.meteo <- lapply(filenames.meteo, read.csv)
# Combine the data frames in the list into a single data frame
meteo <- do.call(rbind, data_list.meteo)

names(meteo)[1] <- "Date"

meteo <- meteo[meteo$Standort=="Zch_Stampfenbachstrasse",]
meteo <- meteo %>% 
  select(c("Date","Parameter","Wert")) %>%
  pivot_wider(id_cols = "Date",names_from = "Parameter",values_from = "Wert") %>%
  select(c("Date","T","RainDur","p"))

meteo$Date <- format(as.Date(meteo$Date), format = "%Y-%m-%d")
meteo$Date <- ymd(meteo$Date)


head(meteo)
```

```{r air, echo=TRUE}

filenames.air <- list.files(path = "../datasets/air/", pattern = "*.csv", full.names = TRUE)
data_list.air <- lapply(filenames.air, read.csv)
# Combine the data frames in the list into a single data frame
air <- do.call(rbind, data_list.air)
names(air)[1] <- "Date"
air$Date <- as.Date(format(air$Date), "%Y-%m-%d")
# add column Jahr
air$Jahr <- as.numeric(format(air$Date,'%Y'))
head(air)

air.wide <- air %>% 
  filter(Standort == "Zch_Stampfenbachstrasse") %>%
  select(c("Date", "Parameter", "Wert")) %>%
  pivot_wider(id_cols = "Date", names_from = "Parameter", values_from = "Wert")

air.short <- air[air$Standort=="Zch_Stampfenbachstrasse",]

air.short <- air.short %>%
  select(c("Date", "Parameter", "Wert")) %>%
  pivot_wider(id_cols = "Date",names_from = "Parameter",values_from = "Wert")

keep <- c("Date", "CO", "NOx")
air.short <- air.short[keep]
keep <- c("Date", "CO")
air.co <- air.short[keep]
keep <- c("Date", "NOx")
air.NOx <- air.short[keep]
#air.NOx <- air["NOx"] <- log(air["NOx"])

```






## Insights into our datasets

```{r plot_air, echo=TRUE}

#melt data frame into long format
air.plot <- melt(air.co,  id.vars = "Date")
#create line plot for each column in data frame
ggplot(air.plot, aes(Date, value), group = 5) +
  geom_line(aes(colour = variable))

```

```{r air.means, echo=TRUE}

air.means = air %>% 
  filter(!is.na(Wert)) %>% 
  group_by(Parameter, Jahr) %>%
  summarize(Mean = round(mean(Wert),2),
            .groups = "drop")

```

```{r air_mean_line_graphs, echo=TRUE}

plot(subset(air.means, Parameter == "CO", 
            c(Jahr, Mean)), type = "l",
     main = "Mean of CO per Year [mg/m3]")  

plot(subset(air.means, Parameter == "NO", 
            c(Jahr, Mean)), type = "l",
     main = "Mean of NO per Year [µg/m3]")

plot(subset(air.means, Parameter == "NO2", 
            c(Jahr, Mean)), type = "l",
     main = "Mean of NO2 per Year [µg/m3]")

plot(subset(air.means, Parameter == "NOx", 
            c(Jahr, Mean)), type = "l",
     main = "Mean of NOx per Year [ppb]")

plot(subset(air.means, Parameter == "O3", 
            c(Jahr, Mean)), type = "l",
     main = "Mean of O3 per Year [µg/m3]") 

plot(subset(air.means, Parameter == "O3_max_h1",
            c(Jahr, Mean)), type = "l",
     main = "Mean of O3_max_h1 per Year [µg/m3]") 

plot(subset(air.means, Parameter == "O3_nb_h1>120",
            c(Jahr, Mean)), type = "l",
     main = "Mean of O3_nb_h1>120 per Year [1]") 

plot(subset(air.means, Parameter == "PM10",
            c(Jahr, Mean)), type = "l",
     main = "Mean of PM10 per Year [mg/m3]") 

plot(subset(air.means, Parameter == "PM2.5",
            c(Jahr, Mean)), type = "l",
     main = "Mean of PM2.5 per Year [mg/m3]") 

plot(subset(air.means, Parameter == "PN",
            c(Jahr, Mean)), type = "l",
     main = "Mean of PN per Year [1/cm3]") 

plot(subset(air.means, Parameter == "SO2",
            c(Jahr, Mean)), type = "l",
     main = "Mean of SO2 per Year [µg/m3]")

```

```{r air.boxplots, echo=TRUE}

# Boxplots for CO all over Zürich
boxplot(Wert ~ Jahr, data = air, subset = Parameter %in% names(table("CO")),
        main= "CO in Zürich (Stampfenbachstrasse) per Year [mg/m3]",
        xlab = "Year", ylab = "mg/m3")
boxplot(Wert ~ Jahr, data = air, subset = Parameter %in% names(table("NOx")),
        main= "NOx in Zürich per Year [ppb]",
        xlab = "Year", ylab = "ppb")

# Boxplots for NOx per monitoring station
air.he <- air %>% filter(Standort == "Zch_HeubeeribÃ¼el")
air.ro <- air %>% filter(Standort == "Zch_Rosengartenstrasse")
air.sc <- air %>% filter(Standort == "Zch_Schimmelstrasse")
air.st <- air %>% filter(Standort == "Zch_Stampfenbachstrasse")

boxplot(Wert ~ Jahr, data = air.he, subset = Parameter %in% names(table("NOx")),
        main= "NOx at Heubeeribuel per Year [ppb]",
        xlab = "Year", ylab = "ppb")
boxplot(Wert ~ Jahr, data = air.ro, subset = Parameter %in% names(table("NOx")),
        main= "NOx at Rosengartenstrasse per Year [ppb]",
        xlab = "Year", ylab = "ppb")
boxplot(Wert ~ Jahr, data = air.sc, subset = Parameter %in% names(table("NOx")),
        main= "NOx at Schimmelstrasse per Year [ppb]",
        xlab = "Year", ylab = "ppb")
boxplot(Wert ~ Jahr, data = air.st, subset = Parameter %in% names(table("NOx")),
        main= "NOx at Stampfenbachstrasse per Year [ppb]",
        xlab = "Year", ylab = "ppb")

```

```{r tree_pflanzjahr, echo=TRUE}

# bar chart pflanzjahr alle
ggplot(d.trees, aes(x = pflanzjahr)) +
  geom_bar() +
  labs(title="Trees per year planted")
# bar chart nur neuere pflanzjahre
ggplot(d.trees[trees$pflanzjahr > 1949, ], aes(x = pflanzjahr)) +
  geom_bar() +
  labs(title="Trees planted as of 1950")

# bar chart kronendurchmesser
ggplot(d.trees, aes(x = kronendurchmesser)) +
  geom_bar() +
  labs(title="Number of trees per crown diameter")

```

# Analysis

## Timeseries Analysis
```{r time_meteo, echo=TRUE}

meteo %<>% complete(Date=seq.Date(min(Date), max(Date), by='day'))

# Use the time series class of the library stats
freq_daily <- 365.2422
temp <-
  ts(meteo$T, start=c(year(min(meteo$Date)),yday(min(meteo$Date))),
     frequency=freq_daily) %>%
  na_replace(fill=0)

# Stationarity test and decomposition
adf.test(temp,k=0)
temp_comp=decompose(temp)
plot(temp_comp)
title(sub = "Temperature")

# Manual decomposition
meteo %<>% mutate(year=year(meteo$Date)+yday(meteo$Date)/freq_daily)
temp_trend <- lm(meteo$T~meteo$year)
plot(temp, main="Temperature trend per year")
abline(temp_trend)


# Yearly and monthly data are already prepared

meteo_yr <- meteo %>%
  mutate(temp_raw=replace_na(T,0)) %>%
  group_by(Year=year(Date)) %>%
  filter(Year>=2010 & Year<=2021) %>%
  summarize(temp=mean(temp_raw)) %>%
  ungroup()


temp_yr <- ts(meteo_yr$temp, start=min(meteo_yr$Year), frequency=1)

```


```{r time_air, echo=TRUE}

air.short %<>% complete(Date=seq.Date(min(Date), max(Date), by='day'))

# Use the time series class of the library stats
freq_daily <- 365.2422
co <-
  ts(air.short$CO, start=c(year(min(air.short$Date)),yday(min(air.short$Date))),
     frequency=freq_daily) %>%
  na_replace(fill=0)
NOx <-
  ts(air.short$NOx, start=c(year(min(air.short$Date)), yday(min(air.short$Date))),
     frequency=freq_daily) %>%
  na_replace(fill=0)

# Stationarity test and decomposition
adf.test(co,k=0)
adf.test(NOx,k=0)
co_comp=decompose(co)
NOx_comp=decompose(NOx)
plot(co_comp)
title(sub = "CO")
plot(NOx_comp)
title(sub = "NOx")


# Manual decomposition
air.short %<>% mutate(year=year(air.short$Date)+yday(air.short$Date)/freq_daily)
co_trend <- lm(air.short$CO~air.short$year)
NOx_trend <- lm(air.short$NOx~air.short$year)
plot(co, main="CO trend per year")
abline(co_trend)
plot(NOx, main="NOx trend per year")
abline(NOx_trend)

air_yr <- air.short %>%
  mutate(co_raw=replace_na(CO,0), NOx_raw=replace_na(NOx,0)) %>%
  group_by(Year=year(Date)) %>%
  filter(Year>=2010 & Year<=2021) %>%
  summarize(co=sum(co_raw), NOx=mean(NOx_raw)) %>%
  ungroup()

# Time series
co_yr <- ts(air_yr$co, start=min(air_yr$Year), frequency=1)
NOx_yr <- ts(air_yr$NOx, start=min(air_yr$Year), frequency=1)

par(mfrow=c(1,1))
plot(co_yr)
plot(NOx_yr)

# Manual decomposition
co_yr_trend <- lm(air_yr$co~air_yr$Year)
plot(co_yr, xlab='Year', ylab='Average co pollution')
abline(co_yr_trend)


plot(co_yr)
pacf(co_yr)
plot(tbats(co_yr)) # Why not decompose()?
plot(residuals(tbats(co_yr)))
adf.test(co_yr)

# Do not use "out of the box" except for exploration
plot(forecast(co_yr))
```

```{r correlation, echo=TRUE}

# Make the time series comparable
temp_comp_random <- data.frame(Date=time(temp_comp$random), Random=temp_comp$random)
co_comp_random <- data.frame(Date=time(co_comp$random), Random=co_comp$random)
NOx_comp_random <- data.frame(Date=time(NOx_comp$random), Random=NOx_comp$random)
#trees_comp_random <- data.frame(Date=time(trees_comp$random), Random=trees_comp$random)


window <- list(start=1980,end=2021)

temp_comp_random %<>% filter(Date>=window$start&Date<window$end)
co_comp_random %<>% filter(Date>=window$start&Date<window$end)
NOx_comp_random %<>% filter(Date>=window$start&Date<window$end)
#trees_comp_random %<>% filter(Date>=window$start&Date<window$end)

temp_comp_random_ts <- ts(temp_comp_random$Random, start=c(window$start,1), frequency=freq_daily)
co_comp_random_ts <- ts(co_comp_random$Random, start=c(window$start,1), frequency=freq_daily)
NOx_comp_random_ts <- ts(NOx_comp_random$Random, start=c(window$start,1), frequency=freq_daily)
#trees_comp_random_ts <- ts(trees_comp_random$Random, start=c(window$start,1), frequency=freq_daily)


# Cross correlation function
# ccf(temp_comp_random_ts,co_comp_random_ts)

ccf(temp_comp_random_ts, co_comp_random_ts, 
    lag.max = 300,
    main = "Temp - CO Cross-Correlation Plot",
    ylab = "CCF", 
    na.action = na.pass)
ccf(tree_ts$count, air_yr$NOx, 
    lag.max = 300,
    main = "Trees - NOx Cross-Correlation Plot",
    ylab = "CCF")
ccf(tree_ts$count, air_yr$co, 
    lag.max = 300,
    main = "Trees - CO Cross-Correlation Plot",
    ylab = "CCF")
ccf(tree_ts$count, meteo_yr$temp, 
    lag.max = 300,
    main = "Trees - Temperature Cross-Correlation Plot",
    ylab = "CCF")
```

# Conclusions and findings


# Outlook and next steps



